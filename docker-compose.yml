services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: devuser
      POSTGRES_PASSWORD: devpassword123
      POSTGRES_DB: intro_microservicios
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devuser -d intro_microservicios"]
      interval: 10s
      timeout: 5s
      retries: 5

  # KAFKA (Versión ligera con KRaft - sin Zookeeper)
  # CONFIGURACIÓN PARA PRUEBAS - Ver comentarios para producción
  kafka:
    image: apache/kafka:4.1.1
    ports:
      - "9092:9092" # Puerto interno para otros contenedores
      - "9093:9093" # Puerto externo para clientes en el host
    environment:
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENERS=INTERNAL://:9092,EXTERNAL://:9093,CONTROLLER://:9094
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_ADVERTISED_LISTENERS=INTERNAL://kafka:9092,EXTERNAL://localhost:9093
      - KAFKA_BROKER_ID=1
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@localhost:9094
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL

      # --- CONFIGURACIÓN DE PRUEBAS ---
      - KAFKA_LOG_RETENTION_HOURS=24 # 1 día en pruebas
      - KAFKA_LOG_RETENTION_BYTES=-1 # Sin límite de tamaño en pruebas
      - KAFKA_NUM_NETWORK_THREADS=2 # Menor uso de recursos
      - KAFKA_NUM_IO_THREADS=2 # Menor uso de recursos

      # --- CONFIGURACIÓN RECOMENDADA PARA PRODUCCIÓN (8GB RAM, 15GB storage) ---
      # - KAFKA_LOG_RETENTION_HOURS=72          # 3 días
      # - KAFKA_LOG_RETENTION_BYTES=10737418240 # 10GB de 15GB disponibles
      # - KAFKA_LOG_SEGMENT_BYTES=1073741824    # 1GB por segmento
      # - KAFKA_LOG_CLEANUP_POLICY=delete       # Eliminar mensajes antiguos
      # - KAFKA_NUM_NETWORK_THREADS=4           # Ajustado a 8GB RAM
      # - KAFKA_NUM_IO_THREADS=4                # Ajustado a 8GB RAM
      # - KAFKA_SOCKET_SEND_BUFFER_BYTES=102400
      # - KAFKA_SOCKET_RECEIVE_BUFFER_BYTES=102400
      # - KAFKA_SOCKET_REQUEST_MAX_BYTES=104857600 # 100MB
      # - KAFKA_AUTO_CREATE_TOPICS_ENABLE=false # Desactivar en producción
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- UI PARA KAFKA (Opcional, pero te ayudará mucho a ver los mensajes) ---
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    ports:
      - "8083:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    depends_on:
      - kafka

  nginx:
    image: nginx:alpine
    ports:
      - "8000:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - get_adults
      - get_children
      - get_adult_by_id
      - get_child_by_id
      - add_child
      - add_member

  get_adults:
    build:
      context: .
      dockerfile: services/get-adults/Dockerfile
    environment: &app_env
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: devuser
      DB_PASSWORD: devpassword123
      DB_NAME: intro_microservicios
      KAFKA_BROKER: kafka:9092
    depends_on:
      postgres:
        condition: service_healthy

  get_children:
    build:
      context: .
      dockerfile: services/get-children/Dockerfile
    environment: *app_env
    depends_on:
      postgres:
        condition: service_healthy

  get_adult_by_id:
    build:
      context: .
      dockerfile: services/get-adult-by-id/Dockerfile
    environment: *app_env
    depends_on:
      postgres:
        condition: service_healthy

  get_child_by_id:
    build:
      context: .
      dockerfile: services/get-child-by-id/Dockerfile
    environment: *app_env
    depends_on:
      postgres:
        condition: service_healthy

  add_adult:
    build:
      context: .
      dockerfile: services/add-adult/Dockerfile
    environment: *app_env
    depends_on:
      postgres:
        condition: service_healthy

  add_child:
    build:
      context: .
      dockerfile: services/add-child/Dockerfile
    environment: *app_env
    depends_on:
      postgres:
        condition: service_healthy

  pick_age:
    build:
      context: .
      dockerfile: services/pick-age/Dockerfile
    environment: *app_env
    depends_on:
      kafka:
        condition: service_healthy
      add_adult:
        condition: service_started
      add_child:
        condition: service_started

  add_member:
    build:
      context: .
      dockerfile: services/add-member/Dockerfile
    environment: *app_env
    depends_on:
      kafka:
        condition: service_healthy
      pick_age:
        condition: service_started

volumes:
  postgres_data:
  kafka_data:
